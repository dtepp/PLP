{% extends "nav.html"%}
{% block title %}{% endblock %}
{% block content %}
<h1 align="center">Start an Analysis</h1>
<style>
.displaydata{
    white-space: pre-wrap; 
    word-wrap: break-word;
}
#process-data {
    font-family: Arial, sans-serif;
}
#process-data th, #process-data td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}
#process-data th {
    background-color: #f2f2f2;
}
#process-data tbody tr:hover {
    background-color: #f5f5f5;
}
</style>   

<form method="POST" enctype="multipart/form-data">
    <label for="text">Description:</label>
    <textarea name="text" id="text" class="form-control"></textarea>
    <br>
    <label for="file">File:</label>
    <input type="file" name="file" id="file" class="form-control-file" onchange="validateFile()">
    <br>
    <div align="left" style="margin-top:20px">
        <button type="submit" class="btn btn-lg btn-primary">submit</button>
        <button type="button" id="preprocess" class="btn btn-lg btn-info">Preprocess</button>
        <button type="button" id="sentiment" class="btn btn-lg btn-warning">Sentiment</button>
        <a href="\home"><button id="back" type="button" class="btn btn-lg btn-secondary">Back</button></a>
        
    </div>
    <div align="right">
        <button id="save" type="button" class="btn btn-lg btn-success">Save</button></a>
    </div>
    
</form>
<br>

<!-- Display area for data read from uploaded file -->
<div align="center" style="width:fit-content">
    <label>Data from uploaded file:</label>
    <pre id="file-data" class="displaydata"></pre>
</div>

<!-- Display area for data Preprocess -->
<div align="center" style="width:fit-content">
    <label>Data after preprocessing:</label>
</div>

<table id="process-data" style="border-collapse: collapse; width: 100%;">
    <thead style="background-color: #f2f2f2;">
        <tr>
            <th >Domain</th>
            <th >Entity</th>
            <th >Sentence</th>
            <!-- Add more columns as needed based on your DataFrame structure -->
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div align="center" style="width:fit-content">
    <label>Sentiment Analysis result:</label>
    <pre id="sentiment-data" class="displaydata"></pre>
</div>


<!-- JavaScript to send form data to backend and display data from backend response -->
<script>
    function validateFile() {
        var fileInput = document.getElementById('file');
        var file = fileInput.files[0];
        

        // Validate file size
        var fileSize = file.size;
        if (fileSize === 0) {
            alert('Error: File size cannot be 0.');
            fileInput.value = ''; // Reset file input
            return;
        }
        if (fileSize > 5 * 1024 * 1024) {
            alert('Error: File size cannot exceed 5 MB.');
            fileInput.value = ''; // Reset file input
            return;
        }

        // Validate file type
        var allowedFileTypes = ['xls', 'xlsx', 'csv'];
        var fileType = file.name.split('.').pop().toLowerCase();
        if (!allowedFileTypes.includes(fileType)) {
            alert('Error: Only files with xls, xlsx, or csv extensions are allowed.');
            fileInput.value = ''; // Reset file input
            return;
        }


 
        
        document.querySelector('form').addEventListener('submit', function(e) {
            e.preventDefault();

            var fileInput = document.getElementById('file');
            var file = fileInput.files[0];
            var textarea = document.getElementById('text');
            var textareaValue = textarea.value;
            if (textareaValue=="") {
                alert('Error: Please input Description to start.');
                return;
            }
          

            var formData = new FormData();
            formData.append('file', file);
            formData.append('text', textareaValue);
            
            // Send form data to backend using fetch
            fetch('/create-post', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                
                var fileDataElement = document.getElementById('file-data');

                // Convert the list of values to an HTML list
                var listElement = document.createElement('ol');
                data.forEach(function(item) {
                    var listItemElement = document.createElement('li');
                    listItemElement.textContent = item;
                    listElement.appendChild(listItemElement);
                });

                // Append the HTML list to the file-data element
                fileDataElement.appendChild(listElement);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        var preprocessData;
        document.querySelector('#preprocess').addEventListener('click', function() {
            fetch('/preprocess', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                preprocessData=data
                var tableBodyElement = document.querySelector('#process-data tbody');
            tableBodyElement.innerHTML = ''; // Clear existing table body

            // Iterate through each row in the data
            data.forEach(function(row) {
                // Create a new row (TR) element
                var rowElement = document.createElement('tr');

                // Iterate through each column in the row
                for (var key in row) {
                    // Create a new cell (TD) element
                    var cellElement = document.createElement('td');
                    cellElement.textContent = row[key];
                    
                    // Append the cell to the row
                    rowElement.appendChild(cellElement);
                }

                // Append the row to the table body
                tableBodyElement.appendChild(rowElement);
                });

                // Append the HTML list to the file-data element
                })
            .catch(error => {
                console.error('Error:', error);
            });
        });
  
        var resulttext;
        var textarea = document.getElementById('text');
        var textareaValue = textarea.value;
        resulttext="["+textareaValue+"]  ";

        document.querySelector('#sentiment').addEventListener('click', function() {

            var formData = new FormData();
            formData.append('preprocess',  JSON.stringify(preprocessData));
            fetch('/sentiment', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                var SentiElement = document.getElementById('sentiment-data');

                // Convert the list of values to an HTML list
                var listElement = document.createElement('ul');
                data.forEach(function(item) {
                    var listItemElement = document.createElement('li');
                    listItemElement.textContent = item;
                    resulttext=resulttext+item;
                    listElement.appendChild(listItemElement);
                });

                // Append the HTML list to the file-data element
                SentiElement.appendChild(listElement);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        document.querySelector('#save').addEventListener('click', function() {

            var formData = new FormData();
            formData.append('text',  JSON.stringify(resulttext));
            fetch('/savepost', {
                method: 'POST',
                body: formData
            })
            .then(response => response)
            .then(data => {
                
                document.getElementById("back").click();
            })
            .catch(error => {
                document.getElementById("back").click();
                console.error('Error:', error);
            });
        });

    }

    
</script>
{% endblock %}
